# ChIP-seq Analysis Pipeline

A Nextflow-based workflow for preprocessing, quality control, single-nucleosome peak calling, and differential enrichment analysis of single-end ChIP-seq data.

---

## Workflow overview

This pipeline performs a complete ChIP-seq data analysis starting from raw FASTQ files and ending with a list of differentially enriched single-nucleosome peaks.  
All steps are fully automated and designed to ensure reproducibility and consistency across computing environments.

---

## Workflow Summary

### 1. Read Preprocessing

- Adapter trimming and quality filtering using **Trimmomatic**
- Removal of low-quality bases and technical artifacts introduced during library preparation and sequencing

**Outputs:**
- Cleaned FASTQ files ready for alignment

---

### 2. Alignment to Reference Genome

- Alignment of trimmed reads to a reference genome (e.g. **GRCm38 / mm10**) using **Bowtie2**
- Sorting and indexing of alignments with **samtools**

**Outputs:**
- Coordinate-sorted BAM files
- BAM index files (`.bai`)

---

### 3. ChIP-seq Library Quality Assessment

- Quality assessment using **PhantomPeakQualTools (SPP)**
- Calculation of strand cross-correlation metrics:
  - **NSC** (Normalized Strand Cross-correlation)
  - **RSC** (Relative Strand Cross-correlation)

**Outputs:**
- Tables with QC metrics
- Diagnostic plots (if supported by the installed SPP version)
- Log files

---

### 4. Identification of Single-Nucleosome Peaks

- Peak calling performed on **pooled ChIP-seq BAM files**
- Control: **MNase-treated input BAM**
- Peak detection using **MACS2** with parameters optimized for single-nucleosome resolution:

```
--shift 37
--extsize 73
```

**Single-nucleosome peak definition:**

A peak is defined as a **147 bp region** centered on the MACS2 summit:
- 73 bp upstream
- 1 bp summit
- 73 bp downstream

**Outputs:**
- BED file with summit coordinates
- BED file with single-nucleosome peak regions (147 bp)

---

### 5. Blacklist Filtering

- Removal of peaks overlapping problematic genomic regions
- Uses DAC/ENCODE blacklist  
  (ENCODE accession: **ENCFF547MET**)

**Outputs:**
- Blacklist-filtered single-nucleosome peak set

---

### 6. Read Counting in Peaks

- Counting of reads overlapping each peak using **bedtools**
- Only reads with alignment quality **MAPQ ≥ 10** are considered
- Counts generated separately for each sample

**Outputs:**
- Per-sample count tables
- Combined count matrix for downstream analysis

---

### 7. Differential Enrichment Analysis

- Differential analysis performed using **DESeq2 (R)**
- Standard DESeq2 parameters
- Peaks with **p-value < 0.05** are classified as differentially enriched

**Outputs:**
- `deseq2_results.tsv` — differential enrichment results
- `normalized_counts.tsv` — normalized read counts

---

## Outputs

Main output files generated by the pipeline:

- Trimmed FASTQ files
- Sorted and indexed BAM files
- QC reports (NSC, RSC)
- Single-nucleosome peak coordinates (BED)
- Blacklist-filtered peak set
- Read count matrices
- Differentially enriched peak list

---

## Usage

### Quick Start

```bash
nextflow run main.nf
```

### Resume interrupted run

```bash
nextflow run main.nf -resume
```

---

## Options (Flags)

### Required parameters

- `--samplesheet`  
  CSV file describing samples and experimental groups

- `--bt2_index`  
  Prefix of the Bowtie2 index for the reference genome

- `--mnase_input_bam`  
  BAM file of MNase-treated input control

### Optional parameters

- `--blacklist_bed`  
  Blacklist BED file (default: `ENCFF547MET.bed`)

- `--macs2_gsize`  
  Genome size for MACS2 (default: `mm`)

- `--outdir`  
  Output directory (default: `results`)

---

## Input Data

### FASTQ files

- Single-end ChIP-seq FASTQ files (`.fastq.gz`)

### Sample sheet format

```csv
sample,group,fastq
sample1,control,/path/to/sample1.fastq.gz
sample2,treated,/path/to/sample2.fastq.gz
```

---

## Requirements

- **Nextflow**
- **Java** (for Trimmomatic)
- **Trimmomatic**
- **Bowtie2**
- **samtools**
- **bedtools**
- **MACS2**
- **R** with **DESeq2**
- **PhantomPeakQualTools (SPP)**

---

## Running the Pipeline

1. Install Nextflow and required dependencies
2. Clone the repository:

```bash
git clone https://github.com/your-org/chipseq-single-nuc-pipeline.git
```

3. Navigate to the pipeline directory:

```bash
cd chipseq-single-nuc-pipeline
```

4. Prepare reference genome and blacklist files
5. Edit `nextflow.config` to match your data paths
6. Run the pipeline:

```bash
nextflow run main.nf
```

---

## License

This project is licensed under the MIT License.
